# 戻るボタン実装 引き継ぎ書

## 📋 実装する機能
**チャットボットの応募部分に「戻る」ボタンを追加**

## 🎯 仕様
- **対象範囲：** 応募部分のみ（名前入力〜連絡方法選択）
- **動作：** 一つ戻るを繰り返し可能、最終的に名前入力まで戻れる
- **データ保持：** 入力済みデータは保持される
- **表示位置：** 各ステップの選択肢下部に統一

## 🔧 実装内容

### 1. ステップ履歴管理
- `stepHistory = []` 配列で履歴を管理
- 各ステップ進行時に履歴に追加
- 戻る時は履歴から一つ削除

### 2. 戻るボタン表示
- `nameStep()` 以外の全ステップに戻るボタン追加
- ボタン位置：選択肢の下、統一スタイル

### 3. 修正対象関数
- `ageStep()` - 年代選択
- `styleStep()` - 働き方選択  
- `reason1Step()` - 応募理由選択
- `reasonSubStep()` - 応募理由サブ選択
- `interviewTimeStep()` - 面接希望時間選択
- `applicationStep()` - 応募文選択
- `contactStep()` - 連絡方法選択

## 📝 実装手順
1. ステップ履歴管理機能を追加
2. 戻る関数を作成  
3. 各ステップに戻るボタンを追加
4. 動作テスト・調整

## ⚠️ 注意点
- 不安要素部分（最初のQ&A）には戻るボタン不要
- 入力データは保持する設計にする
- UIの一貫性を保つ

# 戻るボタン実装 引き継ぎ記録

## 📋 実装した機能
**チャットボットの応募部分に戻るボタンを追加**
- 対象：名前入力→年代選択→働き方→応募理由→応募文選択→面接希望時間→連絡方法選択
- 一つ戻るを繰り返し可能、最終的に名前入力まで戻れる
- 入力済みデータは保持される

## 🛠️ 実装したコード

### 1. ステップ履歴管理システム追加（527行目あたり）
```typescript
// 戻るボタン用のステップ履歴管理
let stepHistory: string[] = [];

// 戻る処理
function goBack() {
  if (stepHistory.length === 0) return;
  
  const prevStep = stepHistory.pop();
  
  // 選択肢・入力欄・注意事項のみクリア（Botメッセージは残す）
  Array.from(document.querySelectorAll(".options-wrap")).forEach(el => el.remove());
  Array.from(document.querySelectorAll("input")).forEach(el => {
    if (el.parentElement) el.parentElement.remove();
  });
  Array.from(document.querySelectorAll("div")).forEach(el => {
    if (el.style.color === "rgb(229, 62, 62)" || el.textContent?.includes("18歳未満")) {
      el.remove();
    }
  });
  
  switch (prevStep) {
    case "name": nameStep(); break;
    case "age": ageStep(); break;
    case "style": styleStep(); break;
    case "reason1": reason1Step(); break;
    case "reasonSub": reasonSubStep(); break;
    case "application": applicationStep(); break;
    case "interviewTime": interviewTimeStep(); break;
  }
}

// 戻るボタンを作成する関数
function createBackButton() {
  // 既存の戻るボタンを削除
  const existingBackBtn = document.getElementById("fixed-back-btn");
  if (existingBackBtn) existingBackBtn.remove();
  
  const backBtn = document.createElement("button");
  backBtn.id = "fixed-back-btn";
  backBtn.textContent = "← 戻る";
  backBtn.style.cssText = `
    position: fixed;
    bottom: 80px;
    left: 20px;
    background: #f5f5f5;
    border: 1px solid #ccc;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 15px;
    color: #666;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    letter-spacing: 1px;
  `;
  backBtn.onclick = goBack;
  document.body.appendChild(backBtn);
  return backBtn;
}
```

### 2. 各ステップ関数に履歴追加
- `ageStep()` → `stepHistory.push("name")`
- `styleStep()` → `stepHistory.push("age")`
- `reason1Step()` → `stepHistory.push("style")`
- `reasonSubStep()` → `stepHistory.push("reason1")`
- `applicationStep()` → 条件分岐で `stepHistory.push("reasonSub")` または `stepHistory.push("reason1")`
- `interviewTimeStep()` → `stepHistory.push("application")`
- `contactStep()` → `stepHistory.push("interviewTime")`

### 3. 各ステップ関数に固定戻るボタン表示追加
```typescript
// 固定戻るボタンを表示
createBackButton();
```

## ❌ 発生した問題点

### 1. **戻るボタンの配置問題**
- 最初：各ステップの選択肢下部に個別配置 → 位置がバラバラ
- 修正：左下固定位置に1つだけ表示

### 2. **前の入力内容が残る問題**
- 戻った時に前のステップの選択肢や入力欄が残って混乱
- 修正：`goBack()`関数でクリア処理を追加

### 3. **戻るボタンが複数残る問題**
- 各ステップで戻るボタンが追加され続ける
- 修正：`createBackButton()`で既存ボタンを削除してから新規作成

### 4. **変数名競合によるTypeScriptエラー**
- `interviewTimes`（配列）と`interviewTimeStep`（関数）の名前が似ているため混乱
- 修正：配列名を`interviewTimeOptions`に変更

## 🔧 修正作業内容

### 1. 戻るボタン配置修正
- 個別配置 → 左下固定位置（`position: fixed; bottom: 80px; left: 20px`）
- 重複防止（既存ボタン削除機能追加）

### 2. クリア処理修正
```typescript
// 選択肢・入力欄・注意事項のみクリア（Botメッセージは残す）
Array.from(document.querySelectorAll(".options-wrap")).forEach(el => el.remove());
```

### 3. 変数名競合解決
```typescript
// 修正前
const interviewTimes = ["平日午前", "平日午後", "土日午前", "土日午後", "相談したい"];

// 修正後  
const interviewTimeOptions = ["平日午前", "平日午後", "土日午前", "土日午後", "相談したい"];
```

## 🚨 現在未解決の問題

### **TypeScriptエラー：621行目**
```
'interviewTimeStep' という名前は見つかりません。'interviewTimeSel' ですか？
```

**原因：**
- 621行目で`interviewTimeStep()`を呼び出し
- 881行目で`interviewTimeStep`関数を定義
- JavaScript/TypeScriptでは使用前に宣言が必要

**エラー箇所：**
```typescript
// 621行目（goBack関数内）
case "interviewTime":
  interviewTimeStep(); // ← エラー：まだ宣言されていない
  break;

// 881行目
function interviewTimeStep() { // ← 宣言がここ
```

## 🎯 達成したい最終状態
1. ✅ 応募部分に戻るボタン表示
2. ✅ 一つ戻るを繰り返し可能
3. ✅ 最終的に名前入力まで戻れる
4. ✅ 入力済みデータ保持
5. ✅ 左下固定位置に1つだけ表示
6. ❌ **TypeScriptエラー解決** ← 未完了

## 🔨 必要な修正作業

### **関数の定義順序修正**
`interviewTimeStep`関数を`goBack`関数より前に移動する
```typescript
// 881行目の関数を585行目あたり（goBack関数の前）に移動
function interviewTimeStep() {
  stepHistory.push("application");
  type(() => {
    bot("面接の希望時間帯を教えてね！都合の良い時間を選んで☺️");
    showList(interviewTimeOptions, (v) => {
      interviewTimeSel = v;
      finishStep();
    });
    createBackButton();
    scroll();
  }, 2000);
}
```

## 📝 検証すべき項目
1. TypeScriptエラーが解消されること
2. チャットボットが正常に起動すること
3. 戻るボタンで各ステップに正常に戻れること
4. 入力データが保持されること
5. 戻るボタンが1つだけ表示されること

---

**担当者：** Claude  
**作業日：** 2025年8月19日  
**状況：** 機能実装完了、TypeScriptエラーのみ未解決